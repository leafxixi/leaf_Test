<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <title>robot testB_Basemap Gallery</title>

  <style>
    @import "http://leaf:3344/arcgis_js_api/310/js/dojo/util/doh/robot/robot.css";
  </style>

  <!-- required: dojo.js -->
  <script type="text/javascript" src="http://leaf:3344/arcgis_js_api/310/js/dojo/dojo/dojo.js"
    data-dojo-config="isDebug: true"></script>
  <script type="text/javascript">
    require(["doh", "dojo/dom", "dojo/robotx", "dojo/keys", "dojo/domReady!"], 
    function(doh, dom, robot, keys){
      robot.initRobot('http://leaf:3344/webappbuilder/?id=2');
        doh.register('testB_Basemap Gallery', {
          name: 'testB_Basemap Gallery',
          timeout: 100000,
          setUp: function(){
            console.log(robot.doc);
          },

          runTest: function(){
            var def = new doh.Deferred();
            console.log(Date.now());
            robot.sequence(function(){//Setting in Builder
            // click widgets pane
            robot.window.require(["dojo/query", 'dijit/registry'], 
              function(query, registry){
              console.log(Date.now());
              var titleAssert=query(".title")[0];
              //robot.assertTrue((titleAssert.innerText=="Web AppBuilder for ArcGIS"));
              if(titleAssert.innerText=="Web AppBuilder for ArcGIS")
                console.log("name is right");
              else
                console.log("name is wrong");

              var widgetsTab = query(".tab-item-icon.widgets")[0];
              console.log(widgetsTab);
              console.log(Date.now());
              robot.mouseMoveAt(widgetsTab, 100, 1000);
              robot.mouseClick({left:true, middle:false, right:false}, 100);

              var Set_action_text = query(".action-text")[0];
              console.log(Set_action_text);
              console.log(Date.now());
              robot.mouseMoveAt(Set_action_text, 100, 1000);
              robot.mouseClick({left:true, middle:false, right:false}, 100);
              //delete Basemap gallery
              robot.sequence(function(){
                var Basemap_gallery = query("[title $= Gallery]")[0];
                console.log(Basemap_gallery);
                console.log(Date.now());
                robot.mouseMoveAt(Basemap_gallery, 100, 1000, Number(37), Number(-50));
                // click delete
                robot.sequence(function(){
                  //doh check basemap-btn delete state 1
                  var doh_basemap_btn_delete_state_1 = Basemap_gallery.parentNode.id;
                  // console.log("doh_testing: "+doh_basemap_btn_delete_state_1);
                  var drop_btn = query(".drop-btn")[0];
                  console.log(drop_btn);
                  console.log(Date.now());
                  robot.mouseMoveAt(drop_btn, 100, 1000);
                  robot.mouseClick({left:true, middle:false, right:false}, 100); 
                  //click ok button
                  robot.sequence(function(){
                    var ok_btn = query(".jimu-popup-btn")[2];
                    console.log(ok_btn);
                    console.log(Date.now());
                    robot.mouseMoveAt(ok_btn, 100, 1000);
                    robot.mouseClick({left:true, middle:false, right:false}, 100); 
                    //add Basemap gallery
                    robot.sequence(function(){
                      Basemap_gallery = query(".add-widget-node")[0];
                      console.log(Basemap_gallery);
                      console.log(Date.now());
                      robot.mouseMoveAt(Basemap_gallery, 100, 1000);
                      robot.mouseClick({left:true, middle:false, right:false}, 100); 
                      //choose basemap gallery 
                      robot.sequence(function(){
                        // search basemapgallery
                        var search = query(".jimu-search")[0];
                        console.log(search);
                        console.log(Date.now());
                        robot.mouseMoveAt(search, 100, 1000);
                        robot.mouseClick({left:true, middle:false, right:false}, 100); 
                        robot.typeKeys("basemapgallery",100,200);
                        // click basemapgallery
                        robot.sequence(function(){
                          Basemap_gallery = query("[title=Basemap Gallery]")[0];
                          console.log(Basemap_gallery);
                          console.log(Date.now());
                          robot.mouseMoveAt(Basemap_gallery, 100, 1000);
                          robot.mouseClick({left:true, middle:false, right:false}, 100);
                          //click ok button
                          ok_btn = query(".jimu-popup-btn")[2];
                          console.log(ok_btn);
                          console.log(Date.now());
                          robot.mouseMoveAt(ok_btn, 100, 1000);
                          robot.mouseClick({left:true, middle:false, right:false}, 100);
                          
                          //edit basemap gallery
                          robot.sequence(function(){  
                            //change basemap gallery name
                            var action = query(".jimu-input")[0];
                            console.log(action);
                            console.log(Date.now());
                            robot.mouseMoveAt(action, 100, 1000);
                            robot.mouseClick({left:true, middle:false, right:false}, 100);
                            robot.keyPress(keys.TAB,0);
                            robot.keyPress(keys.TAB,0,{shift:true});
                            robot.typeKeys("testB_basemapgallery",100,200);                                 
                            // //change include.portal's.basemap_checkbox
                            // action = query(".jimu-checkbox")[2];
                            // console.log(action);
                            // console.log(Date.now());
                            // robot.mouseMoveAt(action, 100, 1000);
                            // robot.mouseClick({left:true, middle:false, right:false}, 100);
                            // robot.mouseClick({left:true, middle:false, right:false}, 1000);
                            //add new basemap
                            robot.sequence(function(){ 
                              action = query(".add_map_text")[0];
                              console.log(action);
                              console.log(Date.now());
                              robot.mouseMoveAt(action, 100, 1000);
                              robot.mouseClick({left:true, middle:false, right:false}, 100);
                              //add sublaer
                              robot.sequence(function(){ 
                                //change title
                                action = query(".dijitPlaceHolder.dijitInputField")[0];
                                console.log(action);
                                console.log(Date.now());
                                robot.mouseMoveAt(action, 100, 1000);
                                robot.mouseClick({left:true, middle:false, right:false}, 100);
                                robot.typeKeys("test_World_Street_Map",100,200); 
                                //change URL
                                action = query(".dijitPlaceHolder.dijitInputField")[1];
                                console.log(action);
                                console.log(Date.now());
                                robot.mouseMoveAt(action, 100, 1000);
                                robot.mouseClick({left:true, middle:false, right:false}, 100);
                                robot.typeKeys("http://server.arcgisonline.com/arcgis/rest/services/World_Street_Map/MapServer",100,200);
                                //add a new Sublayer RUL
                                action = query(".add-layer-url-icon")[0];
                                console.log(action);
                                console.log(Date.now());
                                robot.mouseMoveAt(action, 100, 200);
                                robot.mouseClick({left:true, middle:false, right:false}, 1000);
                                //delete a new Sublayer RUL
                                robot.sequence(function(){
                                  action = query(".delete-layer-url-icon")[0];
                                  console.log(action);
                                  console.log(Date.now());
                                  robot.mouseMoveAt(action, 100, 200);
                                  robot.mouseClick({left:true, middle:false, right:false}, 1000);
                                  //change Thumbnail
                                  robot.sequence(function(){
                                    action = query(".thumbnail-img")[0];
                                    console.log(action);
                                    console.log(Date.now());
                                    robot.mouseMoveAt(action, 100, 200);
                                    robot.mouseClick({left:true, middle:false, right:false}, 1000);
                                    //needs selection by man   **此处有问题，如果选择的图片文件高度过大，则会导致整个排版下移，无法选中下面的ok-btn
                                    //chick ok button 
                                    robot.sequence(function(){
                                      ok_btn = query(".jimu-popup-btn")[6];
                                      console.log(ok_btn);
                                      console.log(Date.now());
                                      robot.mouseMoveAt(ok_btn, 100, 1000);
                                      robot.mouseClick({left:true, middle:false, right:false}, 1000);
                                      //back to edit
                                      robot.sequence(function(){
                                        //change basemap gallery icon                              
                                        action = query(".jimu-image-chooser.js-fileapi-wrapper.change-icon")[0];
                                        console.log(action);
                                        console.log(Date.now());
                                        robot.mouseMoveAt(action, 100, 1000);
                                        robot.mouseClick({left:true, middle:false, right:false}, 1000);
                                        //needs selection by man
                                        //chick ok button
                                        ok_btn = query(".jimu-popup-btn")[2];
                                        console.log(ok_btn);
                                        console.log(Date.now());
                                        robot.mouseMoveAt(ok_btn, 100, 1000);
                                        robot.mouseClick({left:true, middle:false, right:false}, 1000);
                                        //test edit cancel-btn
                                        robot.sequence(function(){
                                          Basemap_gallery = query('[title=testB_basemapgallery]')[0];
                                          console.log(Basemap_gallery);
                                          console.log(Date.now());
                                          robot.mouseMoveAt(Basemap_gallery, 100, 1000, Number(37) , Number(-50) );
                                          //click edit button
                                          robot.sequence(function(){ 
                                            edit_btn = query(".edit-btn")[0];
                                            console.log(edit_btn);
                                            console.log(Date.now());
                                            robot.mouseMoveAt(edit_btn, 100, 1000);
                                            robot.mouseClick({left:true, middle:false, right:false}, 100);
                                            //edit basemap gallery
                                            robot.sequence(function(){  
                                              //change basemap gallery name
                                              action = query(".jimu-input")[0];
                                              console.log(action);
                                              console.log(Date.now());
                                              robot.mouseMoveAt(action, 100, 1000);
                                              robot.mouseClick({left:true, middle:false, right:false}, 100);
                                              robot.keyPress(keys.TAB,0);
                                              robot.keyPress(keys.TAB,0,{shift:true});
                                              robot.typeKeys("testB_basemapgallery_changed",100,200);  
                                              //click cancel-btn
                                              ok_btn = query(".jimu-popup-btn")[0];
                                              console.log(ok_btn);
                                              console.log(Date.now());
                                              robot.mouseMoveAt(ok_btn, 100, 1000);
                                              robot.mouseClick({left:true, middle:false, right:false}, 100);
                                              //check the cancel-btn's result
                                              var BuilderQuery = query;
                                              robot.sequence(function(){
                                              //跳转右侧
                                                robot.window.frames['previewFrame'].require(["dojo/query"], function(query){
                                                  //doh check bookmark-btn delete state 2
                                                  var doh_Basemap_btn_delete_state_2 = BuilderQuery("[title=testB_basemapgallery]")[0].parentNode.id;
                                                  console.log("doh_Basemap_btn_delete_state_2: "+doh_Basemap_btn_delete_state_2);
                                                  //doh check the basemap gallery Name
                                                  var doh_Basemap_Name = Basemap_gallery.innerText;
                                                  // console.log("doh_testing: "+doh_Basemap_Name);
                                                  //click basemap gallery in App Bar
                                                  var more_btn = query("[title=more]")[0];  
                                                  var flag = undefined != more_btn ; 
                                                  console.log(more_btn);
                                                  console.log(flag);
                                                  console.log(Date.now()); 
                                                  if(flag){
                                                    robot.mouseMoveAt(more_btn, 10, 10);
                                                    robot.mouseClick({left:true, middle:false, right:false}, 10);
                                                  }else{
                                                    action = query(".icon-node")[0];
                                                    console.log(action);
                                                    console.log(Date.now());
                                                    robot.mouseMoveAt(action, 100, 1000);
                                                    robot.mouseClick({left:true, middle:false, right:false}, 100);
                                                  }
                                                  // if there is a more btn
                                                  robot.sequence(function(){
                                                    if(flag){
                                                      var next_page = query(".points-inner")[0];
                                                      if(next_page != undefined && next_page.hasChildNodes()){
                                                        console.log(next_page);
                                                        console.log(Date.now());
                                                        robot.mouseMoveAt(next_page.lastChild, 10, 10);
                                                        robot.mouseClick({left:true, middle:false, right:false}, 10);
                                                      }
                                                      var bookmark_btn = query("[title=testB_basemapgallery]")[0];
                                                      console.log(bookmark_btn);
                                                      console.log(Date.now());
                                                      robot.mouseMoveAt(bookmark_btn, 100, 1000);
                                                      robot.mouseClick({left:true, middle:false, right:false}, 100);
                                                    }
                                                    //choose a basemap gallery
                                                    robot.sequence(function(){
                                                      //doh check basemap gallery icon in header
                                                      var doh_icon_in_header = bookmark_btn.firstChild.src; 
                                                      // console.log("icon src = "+ doh_icon_in_header);
                                                      action = query(".esriBasemapGalleryThumbnail")[3];
                                                      console.log(action);
                                                      console.log(Date.now());
                                                      robot.mouseMoveAt(action, 100, 1000);
                                                      robot.mouseClick({left:true, middle:false, right:false}, 100);
                                                      //添加断言        
                                                      robot.sequence(def.getTestCallback(function(){
                                                        console.log('doh_testing:');                          
                                                        doh.isNot(doh_basemap_btn_delete_state_1,doh_Basemap_btn_delete_state_2,"Basemap Gallery has been deleted!");
                                                        doh.is("testB_basemapgallery",doh_Basemap_Name,"Basemap Gallery Name has been changed!");
                                                        doh.isNot("/webappbuilder/apps/9/widgets/BasemapGallery/images/icon.png",doh_icon_in_header,"Basemap Gallery icon has been changed!");
                                                      }), 3000);//添加断言 
                                                    },2000);//choose a basemap gallery
                                                  },2000);// if there is a more btn
                                                });//跳转右侧
                                              },2000);//check the cancel-btn's result
                                            },2000);//edit basemap gallery
                                          },2000);//click edit button
                                        },2000);//test edit cancel-btn
                                      },2000)//back to edit
                                    },2000)//chick ok button
                                  },2000);//change Thumbnail
                                },2000);//delete a new Sublayer RUL
                              },2000);//add sublaer
                            },2000);//add new basemap                                
                          },2000);//edit basemap gallery
                        },2000);// click basemapgallery
                      },2000);//choose basemap gallery 
                    },2000);//add Basemap gallery
                  },2000);//click ok button
                },2000);// click delete
              },2000);//delete Basemap gallery
            }); // click widgets pane
           }, 5000);               
            return def;
          }
        });
      doh.run();
    });
  </script>
</head>
</html>
