<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <title>robot testB_Geoprocessing</title>

  <style>
    @import "http://leaf:3344/arcgis_js_api/310/js/dojo/util/doh/robot/robot.css";
  </style>

  <!-- required: dojo.js -->
  <script type="text/javascript" src="http://leaf:3344/arcgis_js_api/310/js/dojo/dojo/dojo.js"
    data-dojo-config="isDebug: true"></script>
  <script type="text/javascript">
    require(["doh", "dojo/dom", "dojo/robotx", "dojo/keys", "dojo/domReady!"], 
    function(doh, dom, robot, keys){
      robot.initRobot('http://leaf:3344/webappbuilder/?id=2');
        doh.register('testB_Geoprocessing', {
          name: 'testB_Geoprocessing',
          timeout: 200000,
          setUp: function(){
            console.log(robot.doc);
          },

          runTest: function(){
            var def = new doh.Deferred();
            console.log(Date.now());
            robot.sequence(function(){
            // start
              robot.window.require(["dojo/query", 'dijit/registry'], 
              function(query, registry){                
                var titleAssert=query(".title")[0];
                console.log(titleAssert);
                console.log(Date.now());
                //doh.assertTrue((titleAssert.innerText=="ArcGIS Web Application"));
                if(titleAssert.innerText=="Web AppBuilder for ArcGIS")
                  console.log("name is right");
                else
                  console.log("name is wrong");
                var widgetsTab = query(".tab-item-icon.widgets")[0];
                console.log(widgetsTab);
                console.log(Date.now());
                robot.mouseMoveAt(widgetsTab, 100, 1000);
                robot.mouseClick({left:true, middle:false, right:false}, 100);
                var Set_action_text = query(".action-text")[0];
                console.log(Set_action_text);
                console.log(Date.now());
                robot.mouseMoveAt(Set_action_text, 100, 1000);
                robot.mouseClick({left:true, middle:false, right:false}, 100);
                //delete Geoprocessing 
                robot.sequence(function(){
                  var Geoprocessing = query("[title=Geoprocessing]")[0];
                  console.log(Geoprocessing);
                  console.log(Date.now());
                  robot.mouseMoveAt(Geoprocessing, 100, 1000, Number(37), Number(-50));
                  // click delete
                  robot.sequence(function(){
                    //doh check Geoprocessing-btn delete state 1
                    var doh_Geoprocessing_btn_delete_state_1 = Geoprocessing.parentNode.id;
                    console.log("doh_testing: "+doh_Geoprocessing_btn_delete_state_1);
                    var drop_btn = query(".drop-btn")[0];
                    console.log(drop_btn);
                    console.log(Date.now());
                    robot.mouseMoveAt(drop_btn, 100, 1000);
                    robot.mouseClick({left:true, middle:false, right:false}, 100); 
                    //click ok button
                    robot.sequence(function(){
                      var ok_btn = query(".jimu-popup-btn")[2];
                      console.log(ok_btn);
                      console.log(Date.now());
                      robot.mouseMoveAt(ok_btn, 100, 1000);
                      robot.mouseClick({left:true, middle:false, right:false}, 100); 
                      //add Geoprocessing
                      robot.sequence(function(){
                        Geoprocessing = query(".add-widget-node")[0];
                        console.log(Geoprocessing);
                        console.log(Date.now());
                        robot.mouseMoveAt(Geoprocessing, 100, 1000);
                        robot.mouseClick({left:true, middle:false, right:false}, 100); 
                        //choose Geoprocessing
                        robot.sequence(function(){
                          // search Geoprocessing
                          var search = query(".jimu-search")[0];
                          console.log(search);
                          console.log(Date.now());
                          robot.mouseMoveAt(search, 100, 1000);
                          robot.mouseClick({left:true, middle:false, right:false}, 100); 
                          robot.typeKeys("Geoprocessing",100,200);
                          // click Geoprocessing
                          robot.sequence(function(){
                            Geoprocessing = query("[title=Geoprocessing]")[0];
                            console.log(Geoprocessing);
                            console.log(Date.now());
                            robot.mouseMoveAt(Geoprocessing, 100, 1000);
                            robot.mouseClick({left:true, middle:false, right:false}, 100);
                            //click ok button
                            ok_btn = query(".jimu-popup-btn")[2];
                            console.log(ok_btn);
                            console.log(Date.now());
                            robot.mouseMoveAt(ok_btn, 100, 1000);
                            robot.mouseClick({left:true, middle:false, right:false}, 100);
                            //doh check icon Src 1
                            var doh_Geoprocessing_icon_src_1 = Geoprocessing.parentNode.firstChild.firstChild.src;
                            console.log("doh_testing: "+doh_Geoprocessing_icon_src_1);
                            //edit Geoprocessing
                            robot.sequence(function(){  
                              //change Geoprocessing name
                              var action = query(".jimu-input")[0];
                              console.log(action);
                              console.log(Date.now());
                              robot.mouseMoveAt(action, 100, 1000);
                              robot.mouseClick({left:true, middle:false, right:false}, 100);
                              robot.keyPress(keys.TAB,0);
                              robot.keyPress(keys.TAB,0,{shift:true});
                              robot.typeKeys("testB_Geoprocessing",100,200);
                              //change icon
                              var action = query(".change-icon")[0];
                              console.log(action);
                              console.log(Date.now());
                              robot.mouseMoveAt(action, 100, 1000);
                              robot.mouseClick({left:true, middle:false, right:false}, 100);
                              //change name of start location
                              action = query(".dijitReset.dijitInputInner")[1];
                              console.log(action);
                              console.log(Date.now());
                              robot.mouseMoveAt(action, 100, 4000);
                              robot.mouseClick({left:true, middle:false, right:false}, 100);
                              robot.keyPress(keys.TAB,0);
                              robot.keyPress(keys.TAB,0,{shift:true});
                              robot.typeKeys("Test_start_location",100,200);
                              //change reminder of start location
                              action = query(".dijitReset.dijitInputInner")[2];
                              console.log(action);
                              console.log(Date.now());
                              robot.mouseMoveAt(action, 100, 1000);
                              robot.mouseClick({left:true, middle:false, right:false}, 100);
                              robot.keyPress(keys.TAB,0);
                              robot.keyPress(keys.TAB,0,{shift:true});
                              robot.typeKeys("Test:Draw the start location on the map",100,200);
                              //choose symbol
                              action = query(".symbol-div-item")[62];
                              console.log(action);
                              console.log(Date.now());
                              robot.mouseMoveAt(action, 100, 1000);
                              robot.mouseClick({left:true, middle:false, right:false}, 100);
                              //change symbol size
                              action = query(".dijitReset.dijitInputInner")[4];
                              console.log(action);
                              console.log(Date.now());
                              robot.mouseMoveAt(action, 100, 1000);
                              robot.mouseClick({left:true, middle:false, right:false}, 100);
                              robot.keyPress(keys.TAB,0,{shift:true});
                              robot.keyPress(keys.TAB,0);
                              robot.typeKeys("21",100,200);
                              //click Drive Time
                              action = query(".link-action-node.param-node")[1];
                              console.log(action);
                              console.log(Date.now());
                              robot.mouseMoveAt(action, 100, 1000);
                              robot.mouseClick({left:true, middle:false, right:false}, 100);
                              //edit Drive Time
                              robot.sequence(function(){
                                //change name of Drive Time
                                action = query(".dijitReset.dijitInputInner")[1];
                                console.log(action);
                                console.log(Date.now());
                                robot.mouseMoveAt(action, 100, 1000);
                                robot.mouseClick({left:true, middle:false, right:false}, 100);
                                robot.keyPress(keys.TAB,0);
                                robot.keyPress(keys.TAB,0,{shift:true});
                                robot.typeKeys("Test_Drive_times",100,200);
                                //change reminder of Drive Time
                                action = query(".dijitReset.dijitInputInner")[2];
                                console.log(action);
                                console.log(Date.now());
                                robot.mouseMoveAt(action, 100, 1000);
                                robot.mouseClick({left:true, middle:false, right:false}, 100);
                                robot.keyPress(keys.TAB,0);
                                robot.keyPress(keys.TAB,0,{shift:true});
                                robot.typeKeys("Test:Please input drive time",100,200);
                                //change default value
                                action = query(".dijitReset.dijitInputInner")[3];
                                console.log(action);
                                console.log(Date.now());
                                robot.mouseMoveAt(action, 100, 1000);
                                robot.mouseClick({left:true, middle:false, right:false}, 100);
                                robot.keyPress(keys.TAB,0,{shift:true});
                                robot.keyPress(keys.TAB,0);
                                robot.typeKeys("8",100,200);
                                //click output
                                action = query(".dijitTitlePaneTextNode")[1];
                                console.log(action);
                                console.log(Date.now());
                                robot.mouseMoveAt(action, 100, 1000);
                                robot.mouseClick({left:true, middle:false, right:false}, 100);
                                //click Output Drive Time Polygons
                                robot.sequence(function(){
                                  action = query(".link-action-node.param-node")[2];
                                  console.log(action);
                                  console.log(Date.now());
                                  robot.mouseMoveAt(action, 100, 1000);
                                  robot.mouseClick({left:true, middle:false, right:false}, 100);
                                  //edit Output Drive Time Polygons
                                  robot.sequence(function(){
                                    //change name of Output Drive Time Polygons
                                    action = query(".dijitReset.dijitInputInner")[1];
                                    console.log(action);
                                    console.log(Date.now());
                                    robot.mouseMoveAt(action, 100, 1000);
                                    robot.mouseClick({left:true, middle:false, right:false}, 100);
                                    robot.keyPress(keys.TAB,0);
                                    robot.keyPress(keys.TAB,0,{shift:true});
                                    robot.typeKeys("Test_Output_Drive_Time_Polygons",100,200);
                                    //change reminder of Output Drive Time Polygons
                                    action = query(".dijitReset.dijitInputInner")[2];
                                    console.log(action);
                                    console.log(Date.now());
                                    robot.mouseMoveAt(action, 100, 1000);
                                    robot.mouseClick({left:true, middle:false, right:false}, 100);
                                    robot.keyPress(keys.TAB,0);
                                    robot.keyPress(keys.TAB,0,{shift:true});
                                    robot.typeKeys("Test:Reminder Of Output Drive Time Polygons",100,200);
                                    //select its shape, color, alpha, outline color, outline width
                                    action = query(".icon-table.fill-icon-table.fill-icon-table-fill")[0].firstChild.firstChild.lastChild;
                                    console.log(action);
                                    console.log(Date.now());
                                    robot.mouseMoveAt(action, 100, 1000);
                                    robot.mouseClick({left:true, middle:false, right:false}, 100);
                                    action = query(".jimu-color-picker")[3];
                                    console.log(action);
                                    console.log(Date.now());
                                    robot.mouseMoveAt(action, 100, 1000);
                                    robot.mouseClick({left:true, middle:false, right:false}, 100);
                                    //select color
                                    robot.sequence(function(){
                                      action = query("td[title=橙色]")[0];
                                      if(action == undefined){
                                        action = query("td[title=orange]")[0];
                                      }
                                      console.log(action);
                                      console.log(Date.now());
                                      robot.mouseMoveAt(action, 100, 1000);
                                      robot.mouseClick({left:true, middle:false, right:false}, 100);
                                      action = query(".dijitSliderImageHandle.dijitSliderImageHandleH")[2];
                                      console.log(action);
                                      console.log(Date.now());
                                      robot.mouseMoveAt(action, 100, 1000);
                                      robot.mousePress({left: true, middle:false, right:false}, 300);
                                      robot.mouseMoveAt(query(".dijitSliderButtonInner")[5], 200, 2000);
                                      robot.mouseRelease({left: true, middle:false, right:false}, 300);
                                      action = query(".jimu-color-picker")[4];
                                      console.log(action);
                                      console.log(Date.now());
                                      robot.mouseMoveAt(action, 100, 1000);
                                      robot.mouseClick({left:true, middle:false, right:false}, 100);
                                      //select outline color
                                      robot.sequence(function(){
                                        action = query("td[title=绯红色]")[1];
                                        if(action == undefined){
                                          action = query("td[title=crimson]")[1];
                                        }
                                        console.log(action);
                                        console.log(Date.now());
                                        robot.mouseMoveAt(action, 100, 1000);
                                        robot.mouseClick({left:true, middle:false, right:false}, 100);
                                        action = query(".dijitReset.dijitInputInner")[12];
                                        console.log(action);
                                        console.log(Date.now());
                                        robot.mouseMoveAt(action, 100, 1000);
                                        robot.mouseClick({left:true, middle:false, right:false}, 100);
                                        robot.keyPress(keys.TAB,0,{shift:true});
                                        robot.keyPress(keys.TAB,0);
                                        robot.typeKeys("5",100,200);
                                        //click ok button
                                        ok_btn = query(".jimu-popup-btn")[2];
                                        console.log(ok_btn);
                                        console.log(Date.now());
                                        robot.mouseMoveAt(ok_btn, 100, 1000);
                                        robot.mouseClick({left:true, middle:false, right:false}, 100);
                                        // iframes跳转至右侧
                                        var BuilderQuery = query;
                                        robot.sequence(function(){
                                          robot.window.frames['previewFrame'].require(["dojo/query"], function(query){
                                            //doh check Geoprocessing-btn delete state 2
                                            var doh_Geoprocessing_btn_delete_state_2 = BuilderQuery("[title=testB_Geoprocessing]")[0].parentNode.id;
                                            console.log("doh_testing: "+doh_Geoprocessing_btn_delete_state_2);
                                            //doh check icon Src 2
                                            var doh_Geoprocessing_icon_src_2 = BuilderQuery("[title=testB_Geoprocessing]")[0].parentNode.firstChild.firstChild.src;
                                            console.log("doh_Geoprocessing_icon_src_2: "+doh_Geoprocessing_icon_src_2);
                                            //doh check widget name 
                                            var doh_Geoprocessing_name = BuilderQuery("[title=testB_Geoprocessing]")[0].innerText =="testB_Geoprocessing";
                                            console.log("doh_Geoprocessing_name: "+doh_Geoprocessing_name);
                                            // click Geoprocessing in header 
                                            var more_btn = query("[title=more]")[0];  
                                            var flag = undefined != more_btn ; 
                                            console.log(more_btn);
                                            console.log(flag);
                                            console.log(Date.now()); 
                                            if(flag){
                                              robot.mouseMoveAt(more_btn, 10, 10);
                                              robot.mouseClick({left:true, middle:false, right:false}, 10);
                                            }else{
                                              Geoprocessing_btn = query(".icon-node")[0];
                                              console.log(Geoprocessing_btn);
                                              console.log(Date.now());
                                              robot.mouseMoveAt(Geoprocessing_btn, 100, 1000);
                                              robot.mouseClick({left:true, middle:false, right:false}, 100);
                                            }
                                            // if there is a more btn
                                            robot.sequence(function(){
                                              if(flag){
                                                var next_page = query(".points-inner")[0];
                                                if(next_page != undefined && next_page.hasChildNodes()){
                                                  console.log(next_page);
                                                  console.log(Date.now());
                                                  robot.mouseMoveAt(next_page.lastChild, 10, 10);
                                                  robot.mouseClick({left:true, middle:false, right:false}, 10);
                                                }
                                                Geoprocessing_btn = query("[title=testB_Geoprocessing]")[0];
                                                console.log(Geoprocessing_btn);
                                                console.log(Date.now());
                                                robot.mouseMoveAt(Geoprocessing_btn, 100, 1000);
                                                robot.mouseClick({left:true, middle:false, right:false}, 100);
                                              }
                                              //choose Esri world Geocoder
                                              robot.sequence(function(){
                                                //doh check Geoprocessing task name
                                                var doh_name_of_start_location = query(".label-text")[0].innerText =="Test_start_location";
                                                console.log("doh_name_of_start_location:"+doh_name_of_start_location);
                                                var doh_reminder_of_start_location = query(".input-label")[0].getAttribute("title") == "Test:Draw the start location on the map";
                                                console.log("doh_reminder_of_start_location:"+doh_reminder_of_start_location);
                                                var doh_name_of_dirve_times = query(".label-text")[1].innerText == "Test_Drive_times";
                                                console.log("doh_name_of_dirve_times:"+doh_name_of_dirve_times);
                                                var doh_reminder_of_dirve_times = query(".input-label")[1].getAttribute("title") == "Test:Please input drive time";
                                                console.log("doh_reminder_of_dirve_times:"+doh_reminder_of_dirve_times);
                                                //input New York City
                                                action = query("[placeholder=Esri World Geocoder]")[0];
                                                console.log(action);
                                                console.log(Date.now());
                                                robot.mouseMoveAt(action, 100, 1000);
                                                robot.mouseClick({left:true, middle:false, right:false}, 100);
                                                robot.typeKeys("New York City",100,4000);
                                                robot.keyPress(keys.ENTER,0);
                                                //put a start location on map 
                                                robot.sequence(function(){
                                                  action = query("[data-geotype=POINT]")[0];
                                                  console.log(action);
                                                  console.log(Date.now());
                                                  robot.mouseMoveAt(action, 100, 1000);
                                                  robot.mouseClick({left:true, middle:false, right:false}, 100);
                                                  //find a location on map
                                                  action = query(".layersDiv")[0];
                                                  console.log(action);
                                                  console.log(Date.now());
                                                  robot.mouseMoveAt(action, 100, 1000, Number(200), Number(150));
                                                  robot.mouseClick({left:true, middle:false, right:false}, 100);
                                                  action = query(".jimu-btn")[0];
                                                  console.log(action);
                                                  console.log(Date.now());
                                                  robot.mouseMoveAt(action, 100, 1000);
                                                  robot.mouseClick({left:true, middle:false, right:false}, 100);
                                                  robot.mouseMoveAt(action, 100, 8000, Number(50), Number(0));
                                                  var doh_result_init = query(".layersDiv")[0].lastChild.childNodes.length;
                                                  //添加断言        
                                                  robot.sequence(def.getTestCallback(function(){
                                                    //doh check map area 
                                                    var doh_result = query(".layersDiv")[0].lastChild.childNodes.length > doh_result_init;
                                                    console.log('doh_result:'+doh_result+" & init:"+doh_result_init);
                                                    var doh_result_on_map = query(".layersDiv")[0].lastChild.firstChild.lastChild;
                                                    var doh_Geoprocessing_result_color = doh_result_on_map.getAttribute("fill") =="rgb(255, 165, 0)";
                                                    console.log('doh_Geoprocessing_result_color:'+doh_Geoprocessing_result_color);
                                                    var doh_Geoprocessing_result_opacity = doh_result_on_map.getAttribute("fill-opacity") == 0;
                                                    console.log('doh_Geoprocessing_result_opacity:'+doh_Geoprocessing_result_opacity);
                                                    var doh_Geoprocessing_result_outpline_color = doh_result_on_map.getAttribute("stroke") == "rgb(220, 20, 60)";
                                                    console.log('doh_Geoprocessing_result_outpline_color:'+doh_Geoprocessing_result_outpline_color);
                                                    var doh_Geoprocessing_result_outpline_width = doh_result_on_map.getAttribute("stroke-width") == 5;
                                                    console.log('doh_Geoprocessing_result_outpline_width:'+doh_Geoprocessing_result_outpline_width);
                                                    doh.isNot(doh_Geoprocessing_btn_delete_state_2,doh_Geoprocessing_btn_delete_state_1,"Geoprocessing widget has been deleted!");
                                                    doh.isNot(doh_Geoprocessing_icon_src_1,doh_Geoprocessing_icon_src_2,"Geoprocessing icon has been changed!");
                                                    doh.t(doh_Geoprocessing_name,"Geoprocessing widget name has been changed!");
                                                    doh.t(doh_name_of_start_location,"name of start location has been changed!");
                                                    doh.t(doh_reminder_of_start_location,"reminder of start location has been changed!");
                                                    doh.t(doh_name_of_dirve_times,"name of dirve times has been changed!");
                                                    doh.t(doh_reminder_of_dirve_times,"reminder of dirve times has been changed!");
                                                    doh.t(doh_result,"Result has shown on the map!");
                                                    doh.t(doh_Geoprocessing_result_color,"Result color is :"+doh_Geoprocessing_result_color);
                                                    doh.t(doh_Geoprocessing_result_opacity,"Result opacity is :"+doh_Geoprocessing_result_opacity);
                                                    doh.t(doh_Geoprocessing_result_outpline_color,"Result outpline_color is :"+doh_Geoprocessing_result_outpline_color);
                                                    doh.t(doh_Geoprocessing_result_outpline_width,"Result outpline_width is :"+doh_Geoprocessing_result_outpline_width);

                                                  }), 3000);//添加断言  
                                                },2000);//put a start location on map 
                                              },2000);//choose Esri world Geocoder
                                            },2000);// if there is a more btn
                                          });
                                        },2000);// iframes跳转至右侧
                                      },2000);//select outline color
                                    },2000);//select color
                                  },2000);//edit Output Drive Time Polygons
                                },2000);//click Output Drive Time Polygons
                              },2000);//edit Drive Time
                            },2000);//edit Geoprocessing
                          },2000);// click Geoprocessing
                        },2000);//choose Geoprocessing
                      },2000);//add Geoprocessing
                    },2000);//click ok button
                  },2000);// click delete
                },2000);//delete Geoprocessing 
              }); // start
            }, 8000);               
            return def;
          }
        });
      doh.run();
    });

  // robot.sequence(function(){
  // },2000);

  </script>
</head>
</html>
